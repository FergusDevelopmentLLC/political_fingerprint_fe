<head>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:400,700" rel="stylesheet">
  <link href='style.css' rel='stylesheet' type='text/css'>
  <title>8values Quiz</title>
  <link rel="icon" type="x-icon" href="icon.png">
  <link rel="shortcut icon" type="x-icon" href="icon.png">
  <meta charset="utf-8">
</head>

<body>
  <script type="application/javascript" src="questions.js"></script>
  <h1>8values <span class="redux">redux</span></h1>
  <h3>Political Fingerprint</h3>
  <hr>
  <h2 style="text-align:center;" id="question-number">Loading...</h2>
  <div class="question">
    <div id="question-text">Indicate below to what degree the question above is flawed.<br />(biased, unclear or otherwise problematic)</div>
  </div>

  <button class="button button-answer" id="answer-01" onclick="accumulateScore( 1.0, this.id)" style="background-color: #1b5e20;">Strongly Agree</button><br />
  <button class="button button-answer" id="answer-02" onclick="accumulateScore( 0.5, this.id)" style="background-color: #4caf50;">Agree</button><br />
  <button class="button button-answer" id="answer-03" onclick="accumulateScore( 0.0, this.id)" style="background-color: #bbbbbb;">Neutral/Unsure</button><br />
  <button class="button button-answer" id="answer-04" onclick="accumulateScore(-0.5, this.id)" style="background-color: #f44336;">Disagree</button> <br />
  <button class="button button-answer" id="answer-05" onclick="accumulateScore(-1.0, this.id)" style="background-color: #b71c1c;">Strongly Disagree</button><br />
  
  <div class="feedback">
    <h4>Question Feedback:</h4>
    <div>Indicate below to what degree the question above is flawed.<br />(biased, unclear or otherwise problematic)</div>
  </div>

  <button class="button button-feedback" id="feedback-01" onclick="javascript:setFeedback(0, this.id)" style="background-color: #1b5e20;">No flaws</button> <br />
  <button class="button button-feedback" id="feedback-02" onclick="javascript:setFeedback(10, this.id)" style="background-color: #4caf50;">Slightly flawed</button> <br />
  <button class="button button-feedback" id="feedback-03" onclick="javascript:setFeedback(20, this.id)" style="background-color: #ff9400;">Significantly flawed</button> <br />
  <button class="button button-feedback" id="feedback-04" onclick="javascript:setFeedback(30, this.id)" style="background-color: #f44336;">Substantially flawed</button> <br />
  <button class="button button-feedback" id="feedback-05" onclick="javascript:setFeedback(40, this.id)" style="background-color: #b71c1c;">Majorly flawed</button> <br />

  <div class="explanation"><textarea id="explain" placeholder="Explain your feedback (optional)."></textarea></div>

  <div class="back-next-wrapper">
    <button class="small_button" onclick="prev_question()" id="back_button">Back</button>
    <button class="small_button_off" id="back_button_off">Back</button>

    <button class="small_button_off" id="next_button_off">Next</button>
    <button class="small_button" onclick="next_question()" id="next_button_on">Next</button>
  </div>
  <br />

  <!-- JavaScript for the test itself -->
  <script>
    var max_econ, max_dipl, max_govt, max_scty; // Max possible scores
    max_econ = max_dipl = max_govt = max_scty = 0;
    var econ, dipl, govt, scty; // User's scores
    econ = dipl = govt = scty = 0;
    var qn = 0; // Question number
    var prev_answer = null;

    let answered = false
    let feedbackGiven = false
    let feedbackScore = 0
    let currentQuestionIterationId = 0

    //const url_prefix = 'http://127.0.0.1:3000'
    const url_prefix = 'http://138.68.23.63:3030'
    
    const params = new URLSearchParams(window.location.search)
    let version = 1
    if(params.has('qv')) {
      version = parseInt(params.get('qv'))
    }

    // turn off next button
    document.getElementById("next_button_on").style.display = 'none'

    const getQuestions = async () => {
      let url = `${url_prefix}/questions/by_version/${version}`
      console.log('url', url)
      return await fetch(url).then(r => r.json())
    }

    init_question();

    for (var i = 0; i < questions.length; i++) {
      max_econ += Math.abs(questions[i].effect.econ)
      max_dipl += Math.abs(questions[i].effect.dipl)
      max_govt += Math.abs(questions[i].effect.govt)
      max_scty += Math.abs(questions[i].effect.scty)
    }

    function removeAllSelectedButtonsFromClass(buttonClass) {
      let buttons = document.getElementsByClassName(buttonClass)
      for (let button of buttons) {
        if (button.classList.contains('button-selected')) {
          button.classList.remove('button-selected')
        }
      }
    }

    async function init_question() {
      questions = await getQuestions()
      
      window.scrollTo({ top: 0, behavior: 'smooth' })
      currentQuestionIterationId = questions[qn].question_iteration_id
      
      document.getElementById("question-text").innerHTML = questions[qn].question;
      document.getElementById("question-number").innerHTML = "Question " + (qn + 1) + " of " + (questions.length);
      if (prev_answer == null) {
        document.getElementById("back_button").style.display = 'none';
        document.getElementById("back_button_off").style.display = 'block';
      } else {
        document.getElementById("back_button").style.display = 'block';
        document.getElementById("back_button_off").style.display = 'none';
      }

      document.getElementById("next_button_on").style.display = 'none';
      document.getElementById("next_button_off").style.display = 'block';

      removeAllSelectedButtonsFromClass('button-answer')
      removeAllSelectedButtonsFromClass('button-feedback')
      document.getElementById('explain').value = ''
    }

    function accumulateScore(mult, id) {
      answered = true
      econ += mult * questions[qn].effect.econ
      dipl += mult * questions[qn].effect.dipl
      govt += mult * questions[qn].effect.govt
      scty += mult * questions[qn].effect.scty
      qn++;
      prev_answer = mult;

      removeAllSelectedButtonsFromClass('button-answer')
      document.getElementById(id).className += " button-selected"

      // Scroll to a certain element
      document.querySelector('.feedback').scrollIntoView({ 
        behavior: 'smooth' 
      })

      if (answered && feedbackGiven) {
        document.getElementById("next_button_on").style.display = 'block'
        document.getElementById("next_button_off").style.display = 'none'
      }
    }

    const setFeedback = (score, id) => {
      feedbackGiven = true
      feedbackScore = score
    
      removeAllSelectedButtonsFromClass('button-feedback')
      document.getElementById(id).className += " button-selected"
    
      if (answered && feedbackGiven) {
        document.getElementById("next_button_on").style.display = 'block'
        document.getElementById("next_button_off").style.display = 'none'
      }
    }
    
    function isEmptyOrSpaces(str){
      return str === null || str.match(/^ *$/) !== null;
    }

    async function next_question() {
      if (answered && feedbackGiven) {
        
        let explanation = document.getElementById('explain').value.trim()
        
        // console.log('currentQuestionIterationId', currentQuestionIterationId)
        // console.log('explanation', explanation)
        // console.log('feedbackScore', feedbackScore)

        let questionResponse = {}
        questionResponse.question_iteration_id = currentQuestionIterationId
        questionResponse.score = feedbackScore
        if (!isEmptyOrSpaces(explanation)) {
          questionResponse.explanation = explanation
        }
        
        const options = {
          method: 'POST',
          headers: new Headers({'content-type': 'application/json'}),
          body: JSON.stringify( { question_response: questionResponse } )
        }

        let apiUrl = `${url_prefix}/question_responses`

        let qr = await fetch(apiUrl, options).then(r => r.json())

        if (qn >= questions.length) {
          results()
        }
        else {
          init_question()
        }
        answered = false
        feedbackGiven = false
        feedbackScore = 0
      }
    }

    function prev_question() {

      if (prev_answer == null) {
        return;
      }
      
      qn--;
      econ -= prev_answer * questions[qn].effect.econ;
      dipl -= prev_answer * questions[qn].effect.dipl;
      govt -= prev_answer * questions[qn].effect.govt;
      scty -= prev_answer * questions[qn].effect.scty;
      prev_answer = null;

      init_question();

    }

    function calc_score(score, max) {
      return (100 * (max + score) / (2 * max)).toFixed(1)
    }

    function results() {
      location.href = `results.html`
        + `?e=${calc_score(econ, max_econ)}`
        + `&d=${calc_score(dipl, max_dipl)}`
        + `&g=${calc_score(govt, max_govt)}`
        + `&s=${calc_score(scty, max_scty)}`
    }

    

  </script>
</body>