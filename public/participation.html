<!DOCTYPE html>
<html>

<head>
  <link href='styles/style.css' rel='stylesheet' type='text/css'>
  <title>PolitiPoint.org</title>
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>

<body>
  <div class='quiz-logo-wrapper'>
    <img src="https://res.cloudinary.com/fergusdev/image/upload/v1602701055/politipoint/logos/politipoint-wordmark-color_ewmxr1.png" />
  </div>
  <hr />
  <h5>Many Thanks!</h5>
  <p class="thankyou-instructions">
    We very much appreciate your feedback, and as mentioned, it will be use to improve question wording in upcoming versions of PolitiPoint.
  </p>
  <p>
    Gibbet maroon scuttle quarterdeck bilged on her anchor fire in the hole dance the hempen jig Yellow Jack fathom belaying pin. 
    Provost red ensign fluke ahoy clap of thunder execution dock gaff loot Privateer brigantine. Take a caulk pink killick rigging 
    barkadeer carouser strike colors plunder crack Jennys tea cup weigh anchor. League overhaul aft hulk pressgang holystone prow reef sails 
    loot scourge of the seven seas. Crow's nest haul wind fathom hogshead draft aft keelhaul transom Pieces of Eight chase guns. Mutiny 
    avast spanker scuttle tack sloop carouser booty pinnace fore.
  </p>
  <h5>Location</h5>
  <p class="thankyou-instructions">
    Based on your IP address, your local county has been approximated to be: <strong><span id="county"></span></strong>
  </p>
  <p class="thankyou-instructions" style="margin-top:1.5rem;">
    If wish to affiliate with a different county, please select it below:
  </p>
  
  <div class="state-county-select-wrapper">
    <div>
      <label for="stateSel">State</label>
      <select class="select-css" id="stateSel" size="1">
        <option value="" selected="selected">-Select state-</option>
      </select>
    </div>
    <div>
      <label for="countySel">County</label>
      <select class="select-css" id="countySel" size="1">
        <option value="" selected="selected">-Select county-</option>
      </select>
    </div>
  </div>

  <h5>Share your results?</h5>
  <p class="thankyou-instructions">
    Gibbet maroon scuttle quarterdeck bilged on her anchor fire in the hole dance the hempen jig Yellow Jack fathom belaying pin. 
    Provost red ensign fluke ahoy clap of thunder execution dock gaff loot Privateer brigantine. 
  </p>

  <div>
    <input type="checkbox" id="optinout" class="optin-out-checkbox" checked="checked" />
    <label class="optinout-label" for="optinout">
      I agree to share my test results that they can be averaged with other results and drive the national map.
    </label>
  </div>

  <div class="home-button-wrapper"><button class="button button-home" id="test-results-button">Test Results</button></div>
  
  <script src="js/defaults.js"></script>
  
  <script>

    const params = new URLSearchParams(atob(window.location.search.substring(1)))
    
    let trId = params.get('tr_id')
    let countyName = params.get('county_name')
    let stateAbbrev = params.get('state_abbrev')
    let countyGeoId = params.get('county_geoid')

    document.getElementById("county").innerHTML = `${countyName} County, ${stateAbbrev}`

    const getStateCounty = async () => {
      let url = `${url_prefix}/counties_by_state`
      return await fetch(url).then(r => r.json())
    }
    
    const populateStateCounty = async () => {
      let stateSelect = document.getElementById("stateSel")	
      let countySelect = document.getElementById("countySel")
      let stateCounty = await getStateCounty()
      
      for(let state of stateCounty) {
        stateSel.options[stateSel.options.length] = new Option(state.name, state.abbrev)
      }

      let countiesForState = stateCounty.filter(state => {
         return state.abbrev === stateAbbrev
      })

      countySelect.length = 1

      for (county of countiesForState[0].counties) {
        countySelect.options[countySelect.options.length] = new Option(`${county.name} County`, county.geoid)
      }

      stateSelect.value = stateAbbrev
      countySelect.value = countyGeoId

      //hm. cannot use arrow function here, why?
      stateSelect.onchange = function () {		 
        
        //https://stackoverflow.com/questions/3364493/how-do-i-clear-all-options-in-a-dropdown-box
        //wow, lots of discussion on this.
        countySelect.length = 1
        
        if (this.selectedIndex < 1) return

        countiesForState = stateCounty.filter(state => {
          return state.abbrev === this.value
        })
        
        for (county of countiesForState[0].counties) {
          countySelect.options[countySelect.options.length] = new Option(`${county.name} County`, county.geoid)
        }

        stateSelect.value = this.value

      }
    }

    populateStateCounty()

    document.getElementById('test-results-button').onclick = function() {
      let countyGeoId = document.getElementById('countySel').value
      let optIn = document.getElementById('optinout').checked

      console.log('countyGeoId', countyGeoId)
      console.log('optIn', optIn)

    }
    
  </script>
</body>

</html>